# 実装計画 - Excel置換アプリ (Go)

## ゴール
フォルダ内のExcelファイルを再帰的に検索し、指定されたテキストを置換するWindowsアプリケーション（EXE）を作成します。
置換箇所は色（R41, G128, B196）で強調表示され、変更内容のCSVレポートが生成されます。また、処理前にExcelファイルが閉じられていることを保証します。

## 環境構築手順 (Go未インストールの場合)
開発およびビルドを行うために、Go言語のインストールが必要です。

1.  **ダウンロード**: [Go公式サイト](https://go.dev/dl/) から Windows用のインストーラー (`go1.xx.x.windows-amd64.msi`) をダウンロードします。
2.  **インストール**: ダウンロードしたmsiファイルを実行し、指示に従ってインストールします。
3.  **確認**: PowerShellを**再起動**し、以下のコマンドを実行してバージョンが表示されることを確認します。
    ```powershell
    go version
    ```

### トラブルシューティング
もし `go` コマンドが認識されない場合（"用語 'go' は...認識されません" エラー）:
1.  **再起動**: VS Code や PowerShell を完全に閉じて、再度開いてください（環境変数の反映に必要です）。
2.  **管理者権限**: ユーザーの環境によっては、PowerShellを「管理者として実行」する必要がある場合があります。
3.  **PATH確認**: 環境変数 `PATH` に `C:\Program Files\Go\bin` (またはインストール先) が含まれているか確認してください。
> [!IMPORTANT]
> **入力方法**: 「検索文字列」と「置換文字列」の指定方法について
> *   **推奨**: 対話形式（exeをダブルクリック -> 「検索する文字は？」と聞かれる）と、コマンドライン引数（`app.exe -search "old" -replace "new"`）の両方をサポートします。
>
> **UI/UX要件**:
> *   処理開始前に、対象となるExcelファイルの総数をカウントして表示する。
> *   処理中はプログレスバー（ステータスバー）で進捗を表示する。
> *   処理完了後、以下の統計情報を表示する:
>     *   実行時間
>     *   処理したファイル数
>     *   置換した単語（箇所）の総数

> [!WARNING]
> **Excelの強制終了**: ファイルがロックされている場合、アプリはExcelプロセスを強制終了（taskkill）しようとします。これにより、他の開いているExcelファイルの未保存データが失われる可能性があります。

## モジュール構成 (ソースツリー)
```text
.
├── main.go                 # エントリーポイント (CLI引数処理, 実行制御)
├── processor/
│   └── processor.go        # ファイル探索と処理の統括
├── excel/
│   └── excel.go            # Excel操作 (読み込み, 置換, スタイル適用, 保存)
├── report/
│   └── report.go           # CSVレポート生成
├── utils/
│   └── system.go           # システム操作 (Excel強制終了など)
├── go.mod                  # Goモジュール定義
└── go.sum                  # 依存関係のチェックサム
```

## 提案する変更
### コア
#### [NEW] [main.go](file:///c:/myapp/presentation/2025.11/2025.11.30.excel変換go/main.go)
- アプリケーションのエントリーポイント。
- フラグの解析、またはユーザー入力の受け付け。
- 再帰的なファイル探索の開始。

#### [NEW] [processor/processor.go](file:///c:/myapp/presentation/2025.11/2025.11.30.excel変換go/processor/processor.go)
- `ProcessFiles(rootDir, search, replace string)`
- `filepath.Walk` を使用してファイルを探索。
- `.xlsx` 拡張子をチェック。

#### [NEW] [excel/excel.go](file:///c:/myapp/presentation/2025.11/2025.11.30.excel変換go/excel/excel.go)
- `ReplaceInFile(path, search, replace string) (changes []Change, err error)`
- `xuri/excelize` ライブラリを使用。
- 全シート・全セルを反復処理。
- 文字列置換を実行。
- スタイル適用（フォント色: R41, G128, B196）。
- ファイル保存。

#### [NEW] [utils/system.go](file:///c:/myapp/presentation/2025.11/2025.11.30.excel変換go/utils/system.go)
- `ForceCloseExcel()`: `taskkill` コマンドを使用してExcelプロセスを終了。

#### [NEW] [report/report.go](file:///c:/myapp/presentation/2025.11/2025.11.30.excel変換go/report/report.go)
- `GenerateCSV(changes []Change, outputPath string)`
- 変更履歴をCSVに出力。

## 検証計画
### 自動テスト
- `ReplaceInFile` の単体テスト（サンプルExcelファイルを使用）。
- スタイル適用の確認（XMLスタイルインデックスのチェック）。

### テストデータによる検証
- **テストデータ**: `03.test/01_成果物(20250926納品分)` フォルダを使用。
- **手順**:
    1.  テストデータフォルダを一時フォルダ（例: `test_sandbox`）にコピー（オリジナルを保持するため）。
    2.  アプリを実行し、`test_sandbox` を対象フォルダとして指定。
    3.  検索文字列と置換文字列を指定して実行。
    4.  実行後、`test_sandbox` 内のExcelファイルを確認し、置換とスタイル適用が正しく行われているか検証。
    5.  生成されたCSVレポートを確認し、変更されたファイルと箇所が網羅されているか確認。

## ビルドと配布
### ビルドコマンド
```powershell
go build -o excel_converter.exe main.go
```
- `excel_converter.exe` が生成されます。
- 配布時はこのEXEファイルのみを配布します（Goは静的リンクなので依存ライブラリの同梱は不要です）。
- **補足**: 配布先のPCに **Goのインストールは不要** です。生成されたEXE単体で動作します。

# Phase 2: 機能追加（検索モード & GUI）

## 1. 検索モード (Search Mode)
*   **概要**: Excelファイルを変更せず、検索ヒットする箇所を特定してCSVレポートのみ出力するモード。
*   **仕様**:
    *   検索文字列のみ指定（置換文字列は無視）。
    *   Excelファイルへの保存（`Save`）を行わない。
    *   文字色・スタイルの変更を行わない。
    *   CSVレポートには「検索ヒット」として記録する（Old Valueのみ、New Valueは空または同一）。

## 2. 簡易GUI (Web Interface)
*   **概要**: ユーザーフレンドリーな操作画面を提供するため、ローカルWebサーバーを立ち上げ、ブラウザで操作する形式を採用します（「CSVダウンロード」の要件に最適）。
*   **画面構成**:
    *   **モード選択**: ラジオボタン（検索モード / 置換モード）
    *   **対象ディレクトリ**: テキスト入力（サーバー側のローカルパスを指定）
    *   **キーワード入力**: 検索文字列、置換文字列（置換モード時のみ有効）
    *   **実行ボタン**: 処理開始
    *   **進捗表示**: プログレスバー、処理中ファイル名
    *   **結果表示**: 完了メッセージ、統計情報（処理数、ヒット数）
    *   **CSVダウンロード**: 生成されたレポートのダウンロードボタン
*   **技術スタック**:
    *   **Backend**: Go standard library (`net/http`) + WebSocket (for progress updates) or Polling.
    *   **Frontend**: HTML5, CSS3 (Modern/Premium Design), JavaScript.

## 変更計画
### Backend
1.  `excel` パッケージ: `ProcessFile` に `dryRun` (bool) オプションを追加。
2.  `main.go`:
    *   CLI引数処理は残しつつ、引数なし（または特定のフラグ）で起動した場合にWebサーバーモードへ移行。
    *   `/api/run`: 処理実行エンドポイント。
    *   `/api/status`: 進捗確認エンドポイント。
    *   `/api/download`: CSVダウンロードエンドポイント。

### Frontend
1.  `static/index.html`: UI実装。
2.  `static/style.css`: プレミアムなデザイン適用。
3.  `static/app.js`: API通信、UI制御。

### 配布について (Single EXE)
*   **`embed` パッケージの利用**: Go 1.16以降の `embed` 機能を使用し、HTML/CSS/JSファイルをEXEファイル内に埋め込みます。
*   これにより、Phase 1同様に **`excel_converter.exe` 1つを配布するだけ** で、Web GUI機能も利用可能になります。別途HTMLフォルダなどを配布する必要はありません。

## 技術スタックと処理概要 (Technical Summary)

### 使用ライブラリ (Libraries)
このアプリケーションは、以下の主要なGoライブラリによって支えられています。

*   **`github.com/xuri/excelize/v2`**:
    *   **役割**: Excelファイル（.xlsx）の読み込み、編集、保存を行うための高性能なライブラリです。
    *   **選定理由**: Go言語で最も普及しており、機能が豊富でメンテナンスも活発なため。
*   **`golang.org/x/text`**:
    *   **役割**: 文字コードの変換（UTF-8 ⇔ Shift-JIS）を担当します。
    *   **用途**: CSVレポートをExcelで文字化けせずに開けるように、Shift-JIS形式で出力するために使用しています。
*   **標準ライブラリ (`net/http`, `embed`, `os/exec` 等)**:
    *   Webサーバー機能、静的ファイルの埋め込み、PowerShellの呼び出し（ディレクトリ選択ダイアログ）などに使用しています。

### Excel処理の仕組み (Processing Logic)
アプリケーションは以下のフローでExcelファイルを処理します。

1.  **ファイル探索**: 指定されたディレクトリを再帰的に探索し、`.xlsx` ファイルを特定します。
2.  **読み込み**: `excelize.OpenFile()` を使用してファイルをメモリ上に展開します。
3.  **全走査**:
    *   ファイル内の「全てのシート」をループします。
    *   各シート内の「使用されている行」と「セル」をループします。
4.  **検索と置換**:
    *   セルの値（文字列）を取得し、検索キーワードが含まれているか判定します。
    *   **置換モードの場合**: 文字列を置換し、`SetCellValue` で値を更新します。さらに、`SetCellStyle` を使用して該当セルに「青色・太字」のスタイルを適用します。
5.  **保存**: 変更があった場合のみ、`Save()` メソッドでファイルを上書き保存します。
6.  **レポート**: 変更内容（ファイル名、シート名、セル位置、置換前後の値）を記録し、最後にShift-JISエンコードされたCSVファイルとして出力します。

